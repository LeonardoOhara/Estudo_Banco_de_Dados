<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Manuten√ß√£o - Completo</title>

<!-- Fonts / Icons -->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#eef2f7; --card:#fff; --accent:#0b78ff; --text:#0f1724; --muted:#6b7280;
    --success:#16a34a; --danger:#ef4444;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#071021; --accent:#3b82f6; --text:#e6eef8; --muted:#94a3b8;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{margin:0;background:var(--bg);color:var(--text);padding:20px;}
  .wrap{max-width:1100px;margin:0 auto;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#2bc1ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  h1{margin:0;font-size:20px}
  .controls{display:flex;gap:8px;align-items:center}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.08);margin-top:16px}
  input,select,textarea,button{font:inherit;border:1px solid #e6eef8;padding:10px;border-radius:8px}
  input:focus,select:focus,textarea:focus{outline:2px solid rgba(11,120,255,0.15)}
  .grid{display:grid;gap:12px}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .grid.cols-2{grid-template-columns:repeat(2,1fr)}
  .row{display:flex;gap:8px;align-items:center}
  button.primary{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left}
  th{background:linear-gradient(90deg,var(--accent),#2bc1ff);color:white;position:sticky;top:0}
  .actions button{margin-right:6px}
  .small{font-size:13px;color:var(--muted)}
  .filters{display:flex;gap:8px;flex-wrap:wrap}
  .right{margin-left:auto;display:flex;gap:8px}
  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:40}
  .modal{width:520px;max-width:95%;background:var(--card);padding:16px;border-radius:12px}
  /* responsive */
  @media (max-width:720px){
    .grid.cols-3{grid-template-columns:1fr}
    .grid.cols-2{grid-template-columns:1fr}
    header{flex-direction:column;align-items:flex-start;gap:12px}
  }
</style>
</head>
<body>
<div class="wrap" id="appRoot" data-theme="light">

  <header>
    <div class="brand">
      <div class="logo">M</div>
      <div>
        <h1>Manuten√ß√£o & Servi√ßos</h1>
        <div class="small">Controle simples - Firebase + Export / PDF / Gr√°ficos</div>
      </div>
    </div>

    <div class="controls">
      <div id="userArea" style="display:none" class="small">Logado como <strong id="userEmail"></strong></div>

      <button id="darkToggle" class="ghost">üåô Tema</button>
      <button id="btnLoginTop" class="primary">Login / Registrar</button>
    </div>
  </header>

  <!-- LOGIN / REGISTRO -->
  <div id="authCard" class="card" style="margin-top:18px;display:none;">
    <div class="grid cols-2">
      <div>
        <h3>Entrar</h3>
        <input id="emailLogin" type="email" placeholder="Email">
        <input id="senhaLogin" type="password" placeholder="Senha">
        <div class="row"><button class="primary" onclick="login()">Entrar</button><button class="ghost" onclick="showRegister()">Criar conta</button></div>
      </div>

      <div id="registerBox" style="display:none">
        <h3>Registrar</h3>
        <input id="emailReg" type="email" placeholder="Email">
        <input id="senhaReg" type="password" placeholder="Senha (min 6)">
        <input id="nomeReg" type="text" placeholder="Nome (opcional)">
        <div class="row"><button class="primary" onclick="register()">Criar Conta</button><button class="ghost" onclick="hideRegister()">Cancelar</button></div>
      </div>
    </div>
  </div>

  <!-- APP PRINCIPAL -->
  <div id="mainApp" style="display:none">

    <div class="card">
      <div class="grid cols-3">
        <div>
          <h3>Nova Manuten√ß√£o</h3>
          <input id="moto" placeholder="Moto (ex: Factor 150)">
          <input id="cliente" placeholder="Cliente (opcional)">
          <input id="servico" placeholder="Servi√ßo (ex: Troca de √≥leo)">
        </div>

        <div>
          <h3>&nbsp;</h3>
          <input id="valor" placeholder="Valor (ex: 50.00)">
          <input id="data" type="date">
          <div style="margin-top:6px"><button class="primary" onclick="salvarNova()">Adicionar</button> <button class="ghost" onclick="limparForm()">Limpar</button></div>
        </div>

        <div>
          <h3>Exportar / A√ß√µes</h3>
          <div class="row">
            <button class="primary" onclick="exportExcel()">Exportar Excel</button>
            <button class="ghost" onclick="exportPDF()">Exportar PDF</button>
            <button class="ghost" onclick="window.print()">Imprimir</button>
          </div>
          <div style="margin-top:8px">
            <button class="ghost" onclick="carregar(true)">Atualizar dados</button>
            <button class="ghost" onclick="mostrarDashboard()">Mostrar Dashboard</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;gap:8px">
        <input id="busca" placeholder="Buscar por moto, servi√ßo ou cliente..." oninput="filtrar()">
        <select id="ordem" onchange="filtrar()">
          <option value="recente">Ordenar: Mais recente</option>
          <option value="antiga">Ordenar: Mais antiga</option>
          <option value="valorDesc">Ordenar: Valor (dec)</option>
          <option value="valorAsc">Ordenar: Valor (asc)</option>
        </select>

        <input id="minValor" placeholder="Valor min" style="width:120px" oninput="filtrar()">
        <input id="maxValor" placeholder="Valor max" style="width:120px" oninput="filtrar()">

        <div class="right small">
          <button class="ghost" onclick="limparFiltros()">Limpar filtros</button>
          <button class="ghost" onclick="logout()">Sair</button>
        </div>
      </div>

      <table id="tbl">
        <thead>
          <tr><th>Moto</th><th>Cliente</th><th>Servi√ßo</th><th>Valor</th><th>Data</th><th>A√ß√£o</th></tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>
    </div>

    <!-- Dashboard -->
    <div id="dash" class="card" style="display:none">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div style="flex:1;min-width:240px">
          <h4>Total por m√™s</h4>
          <canvas id="chartMonth" height="140"></canvas>
        </div>
        <div style="flex:1;min-width:240px">
          <h4>Distribui√ß√£o por servi√ßo (top)</h4>
          <canvas id="chartService" height="140"></canvas>
        </div>
        <div style="width:220px">
          <h4>Resumo</h4>
          <div class="small">Total registros: <strong id="totalRegs">0</strong></div>
          <div class="small">Total gasto: <strong id="totalSpent">R$ 0.00</strong></div>
          <div style="margin-top:8px"><button class="ghost" onclick="fecharDashboard()">Fechar</button></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Edi√ß√£o -->
  <div id="modal" style="display:none" class="modal-back">
    <div class="modal">
      <h3>Editar Manuten√ß√£o</h3>
      <input id="editMoto">
      <input id="editCliente">
      <input id="editServico">
      <input id="editValor">
      <input id="editData" type="date">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="primary" onclick="salvarEdit()">Salvar</button>
        <button class="ghost" onclick="closeModal()">Cancelar</button>
        <button class="ghost" style="margin-left:auto" onclick="deleteEdit()">Apagar</button>
      </div>
    </div>
  </div>

</div>

<!-- LIBS -->
<!-- Firebase compat (para facilidade) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- SheetJS para Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- jsPDF para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ================== CONFIGURE AQUI ==================
 Substitua as propriedades abaixo pela sua firebaseConfig
 =================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyB9St2-KhyhA7s6o_MsmkWOI8Feb0zytoM",
  authDomain: "controle-manutencao-20df9.firebaseapp.com",
  databaseURL: "https://controle-manutencao-20df9-default-rtdb.firebaseio.com",
  projectId: "controle-manutencao-20df9",
  storageBucket: "controle-manutencao-20df9.firebasestorage.app",
  messagingSenderId: "778808552103",
  appId: "1:778808552103:web:44ba1b6f586dfdaf1e8982"
};
/* ================================================== */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* UI refs */
const authCard = document.getElementById('authCard');
const mainApp = document.getElementById('mainApp');
const userArea = document.getElementById('userArea');
const userEmail = document.getElementById('userEmail');
const listaEl = document.getElementById('lista');
const modalBack = document.getElementById('modal');
const root = document.getElementById('appRoot');

let cache = []; // cache local
let editId = null;
let charts = { month: null, service: null };

/* Tema */
const darkToggle = document.getElementById('darkToggle');
function applyTheme(t){
  root.setAttribute('data-theme', t);
  localStorage.setItem('theme', t);
  darkToggle.textContent = t === 'dark' ? '‚òÄÔ∏è Claro' : 'üåô Escuro';
}
darkToggle.addEventListener('click', ()=>{
  const cur = root.getAttribute('data-theme') || 'light';
  applyTheme(cur === 'light' ? 'dark' : 'light');
});
const savedTheme = localStorage.getItem('theme') || 'light';
applyTheme(savedTheme);

/* Auth UI */
document.getElementById('btnLoginTop').addEventListener('click', () => {
  authCard.style.display = authCard.style.display === 'none' ? 'block' : 'none';
});

function showRegister(){ document.getElementById('registerBox').style.display='block'; }
function hideRegister(){ document.getElementById('registerBox').style.display='none'; }

/* Auth functions */
function login(){
  const email = document.getElementById('emailLogin').value;
  const senha = document.getElementById('senhaLogin').value;
  if(!email||!senha) return alert('Preencha email e senha');
  auth.signInWithEmailAndPassword(email, senha).catch(e=>alert(e.message));
}

function register(){
  const email = document.getElementById('emailReg').value;
  const senha = document.getElementById('senhaReg').value;
  const nome = document.getElementById('nomeReg').value || '';
  if(!email||!senha) return alert('Preencha email e senha');
  auth.createUserWithEmailAndPassword(email, senha)
    .then(result => {
      // opcional: salvar nome do usu√°rio no profile
      if(nome) result.user.updateProfile({ displayName: nome });
      alert('Conta criada! Voc√™ j√° est√° logado.');
    }).catch(e=>alert(e.message));
}

function logout(){ auth.signOut(); }

/* Observa estado auth */
auth.onAuthStateChanged(user => {
  if(user){
    authCard.style.display = 'none';
    mainApp.style.display = 'block';
    userArea.style.display = 'block';
    userEmail.textContent = user.email || user.displayName || 'Usuario';
    carregar();
  } else {
    mainApp.style.display = 'none';
    userArea.style.display = 'none';
    authCard.style.display = 'block';
  }
});

/* CRUD */
function limparForm(){
  ['moto','cliente','servico','valor','data'].forEach(id=>document.getElementById(id).value='');
}

function salvarNova(){
  const moto = document.getElementById('moto').value.trim();
  const cliente = document.getElementById('cliente').value.trim();
  const servico = document.getElementById('servico').value.trim();
  const valorRaw = document.getElementById('valor').value.trim();
  const data = document.getElementById('data').value;

  if(!moto || !servico || !valorRaw || !data) return alert('Preencha moto, servi√ßo, valor e data');

  const valor = parseFloat(valorRaw.replace(',','.')) || 0;

  db.collection('manutencoes').add({
    uid: auth.currentUser.uid,
    moto, cliente, servico, valor, data,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{ limparForm(); carregar(true); });
}

function carregar(force=false){
  // carrega do firestore e atualiza cache
  db.collection('manutencoes').where('uid','==', auth.currentUser.uid).get()
    .then(snap=>{
      cache = [];
      snap.forEach(doc=>{
        cache.push({ id: doc.id, ...doc.data() });
      });
      filtrar();
      if(force) alert('Dados atualizados');
    })
    .catch(e=>console.error(e));
}

function filtrar(){
  const q = (document.getElementById('busca').value||'').toLowerCase();
  const ordem = document.getElementById('ordem').value;
  const minV = parseFloat((document.getElementById('minValor').value||'').replace(',','.')) || null;
  const maxV = parseFloat((document.getElementById('maxValor').value||'').replace(',','.')) || null;

  let out = cache.filter(x=>{
    const inText = (x.moto||'').toLowerCase().includes(q) || (x.servico||'').toLowerCase().includes(q) || (x.cliente||'').toLowerCase().includes(q);
    const inMin = minV===null ? true : (x.valor >= minV);
    const inMax = maxV===null ? true : (x.valor <= maxV);
    return inText && inMin && inMax;
  });

  if(ordem === 'recente') out.sort((a,b)=> (b.data||'').localeCompare(a.data||'') );
  else if(ordem === 'antiga') out.sort((a,b)=> (a.data||'').localeCompare(b.data||'') );
  else if(ordem === 'valorDesc') out.sort((a,b)=> b.valor - a.valor);
  else if(ordem === 'valorAsc') out.sort((a,b)=> a.valor - b.valor);

  renderList(out);
}

function renderList(items){
  listaEl.innerHTML = '';
  document.getElementById('totalRegs').textContent = items.length;
  const total = items.reduce((s,i)=>s + (parseFloat(i.valor)||0),0);
  document.getElementById('totalSpent').textContent = 'R$ ' + total.toFixed(2);

  items.forEach(i=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(i.moto||'')}</td>
      <td>${escapeHtml(i.cliente||'')}</td>
      <td>${escapeHtml(i.servico||'')}</td>
      <td>R$ ${Number(i.valor||0).toFixed(2)}</td>
      <td>${i.data||''}</td>
      <td class="actions">
        <button class="ghost" onclick="openEdit('${i.id}')">Editar</button>
        <button class="ghost" onclick="duplicate('${i.id}')">Duplicar</button>
        <button class="ghost" style="background:${'var(--danger)'};color:#fff" onclick="remove('${i.id}')">Apagar</button>
      </td>
    `;
    listaEl.appendChild(tr);
  });
}

/* util */
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* Edit modal */
function openEdit(id){
  editId = id;
  const doc = cache.find(x=>x.id===id);
  if(!doc) return alert('Registro n√£o encontrado');
  document.getElementById('editMoto').value = doc.moto||'';
  document.getElementById('editCliente').value = doc.cliente||'';
  document.getElementById('editServico').value = doc.servico||'';
  document.getElementById('editValor').value = doc.valor||'';
  document.getElementById('editData').value = doc.data||'';
  modalBack.style.display = 'flex';
}
function closeModal(){ modalBack.style.display = 'none'; editId = null; }
function salvarEdit(){
  if(!editId) return;
  const moto = document.getElementById('editMoto').value.trim();
  const cliente = document.getElementById('editCliente').value.trim();
  const servico = document.getElementById('editServico').value.trim();
  const valor = parseFloat((document.getElementById('editValor').value||'').replace(',','.')) || 0;
  const data = document.getElementById('editData').value;
  if(!moto||!servico||!data) return alert('Preencha moto, servi√ßo e data');
  db.collection('manutencoes').doc(editId).update({ moto, cliente, servico, valor, data })
    .then(()=>{ closeModal(); carregar(true); });
}
function deleteEdit(){
  if(!editId) return;
  if(!confirm('Confirmar exclus√£o?')) return;
  db.collection('manutencoes').doc(editId).delete().then(()=>{ closeModal(); carregar(true); });
}

/* duplicar */
function duplicate(id){
  const doc = cache.find(x=>x.id===id);
  if(!doc) return;
  const copy = { ...doc };
  delete copy.id;
  copy.createdAt = firebase.firestore.FieldValue.serverTimestamp();
  db.collection('manutencoes').add(copy).then(()=> carregar(true));
}

/* remover */
function remove(id){
  if(!confirm('Confirmar exclus√£o?')) return;
  db.collection('manutencoes').doc(id).delete().then(()=> carregar(true));
}

/* EXPORTAR EXCEL (SheetJS) */
function exportExcel(){
  if(!cache.length) return alert('Sem dados para exportar');
  // transforma para worksheet
  const data = cache.map(i=>({
    Moto: i.moto||'',
    Cliente: i.cliente||'',
    Servico: i.servico||'',
    Valor: Number(i.valor||0).toFixed(2),
    Data: i.data||'',
    ID: i.id
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Manutencoes');
  XLSX.writeFile(wb, 'manutencoes.xlsx');
}

/* EXPORTAR PDF (jsPDF) */
async function exportPDF(){
  if(!cache.length) return alert('Sem dados para exportar');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  doc.setFontSize(14);
  doc.text('Relat√≥rio de Manuten√ß√µes', 40, 40);
  const rows = cache.map(i=>[i.moto||'', i.cliente||'', i.servico||'', 'R$ '+Number(i.valor||0).toFixed(2), i.data||'']);
  doc.autoTable({
    head:[['Moto','Cliente','Servi√ßo','Valor','Data']],
    body: rows,
    startY: 60,
    margin: { left: 40, right: 40 }
  });
  doc.save('manutencoes.pdf');
}

/* Dashboard */
function mostrarDashboard(){
  document.getElementById('dash').style.display = 'block';
  buildCharts();
}
function fecharDashboard(){
  document.getElementById('dash').style.display = 'none';
}

function buildCharts(){
  // TOTAL POR M√äS
  const mapMonth = {};
  cache.forEach(i=>{
    const d = i.data || '';
    const key = d ? d.slice(0,7) : 'unknown'; // yyyy-mm
    mapMonth[key] = (mapMonth[key] || 0) + (Number(i.valor)||0);
  });
  const months = Object.keys(mapMonth).sort();
  const totals = months.map(m=>mapMonth[m]);

  // SERVI√áOS TOP
  const mapService = {};
  cache.forEach(i=>{
    const s = i.servico || 'Outros';
    mapService[s] = (mapService[s] || 0) + 1;
  });
  const services = Object.entries(mapService).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const serviceLabels = services.map(s=>s[0]);
  const serviceValues = services.map(s=>s[1]);

  // atualizar charts
  if(charts.month) charts.month.destroy();
  if(charts.service) charts.service.destroy();

  const ctxM = document.getElementById('chartMonth').getContext('2d');
  charts.month = new Chart(ctxM, {
    type: 'bar',
    data: { labels: months, datasets: [{ label: 'Total R$', data: totals, borderRadius:6 }] },
    options:{ responsive:true, plugins:{legend:{display:false}} }
  });

  const ctxS = document.getElementById('chartService').getContext('2d');
  charts.service = new Chart(ctxS, {
    type: 'pie',
    data: { labels: serviceLabels, datasets:[{ data: serviceValues }] },
    options:{ responsive:true }
  });
}

/* Helper to add autoTable plugin (jsPDF-autotable) - loads dynamically */
(function loadAutoTable(){
  const s = document.createElement('script');
  s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js';
  document.head.appendChild(s);
})();

/* Inicial */
carregar();

/* fun√ß√£o para atualizar cache quando mudan√ßa remota (opcional) */
// Voc√™ pode ativar listener em tempo real se desejar:
// db.collection('manutencoes').where('uid','==', auth.currentUser.uid)
//   .onSnapshot(snapshot => { /* atualizar cache e filtrar */ });

</script>
</body>
</html>
