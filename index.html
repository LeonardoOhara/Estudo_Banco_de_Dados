<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema de Manutenção — Email/Senha + Recuperação</title>
<style>
  :root{--bg:#f3f6fb;--card:#fff;--accent:#0b78ff;--danger:#ef4444;--muted:#6b7280}
  *{box-sizing:border-box;font-family:Inter,Arial,Helvetica,sans-serif}
  body{margin:0;background:var(--bg);color:#0b1220;padding:18px}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#2bc1ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  h1{margin:0;font-size:18px}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06);margin-top:14px}
  input,select,button,textarea{font:inherit;padding:10px;border-radius:8px;border:1px solid #e6eef8}
  input:focus,select:focus,textarea:focus{outline:2px solid rgba(11,120,255,0.12)}
  button.primary{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid #d1d5db;padding:10px;border-radius:8px;cursor:pointer}
  .row{display:flex;gap:8px;align-items:center}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left}
  th{background:linear-gradient(90deg,var(--accent),#2bc1ff);color:#fff;position:sticky;top:0}
  .small{font-size:13px;color:var(--muted)}
  .actions button{margin-right:6px}
  .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal{width:520px;max-width:95%;background:var(--card);padding:16px;border-radius:12px}
  @media(max-width:720px){header{flex-direction:column;align-items:flex-start} .row{flex-direction:column}}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="brand">
      <div class="logo">M</div>
      <div>
        <h1>Sistema de Manutenção</h1>
        <div class="small">Email/Senha + Recuperação — Firestore por usuário</div>
      </div>
    </div>

    <div id="topControls" class="row">
      <div id="userInfo" style="display:none" class="small">Olá, <strong id="userLabel"></strong></div>
      <button id="btnShowAuth" class="primary">Entrar / Registrar</button>
    </div>
  </header>

  <!-- AUTH -->
  <div id="authCard" class="card" style="display:none">
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <!-- LOGIN -->
      <div style="flex:1;min-width:260px">
        <h3>Entrar</h3>
        <input id="emailLogin" type="email" placeholder="Email">
        <input id="senhaLogin" type="password" placeholder="Senha">
        <div class="row" style="margin-top:8px">
          <button class="primary" onclick="login()">Entrar</button>
          <button class="ghost" onclick="showRegister()">Criar conta</button>
        </div>
        <div style="margin-top:8px">
          <a href="#" onclick="recuperarSenha();return false;" class="small">Esqueci a senha</a>
        </div>
      </div>

      <!-- REGISTRO -->
      <div id="registerBox" style="flex:1;min-width:260px;display:none">
        <h3>Criar Conta</h3>
        <input id="emailReg" type="email" placeholder="Email">
        <input id="senhaReg" type="password" placeholder="Senha (mín 6)">
        <input id="nomeReg" type="text" placeholder="Nome (opcional)">
        <div class="row" style="margin-top:8px">
          <button class="primary" onclick="register()">Registrar</button>
          <button class="ghost" onclick="hideRegister()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <div class="card">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:220px">
          <input id="moto" placeholder="Moto (ex: Factor 150)">
          <input id="cliente" placeholder="Cliente (opcional)">
          <input id="servico" placeholder="Serviço (ex: Troca óleo)">
        </div>
        <div style="min-width:200px">
          <input id="valor" placeholder="Valor (ex: 50.00)">
          <input id="data" type="date">
          <div style="margin-top:8px" class="row">
            <button class="primary" onclick="salvarNova()">Adicionar</button>
            <button class="ghost" onclick="limparForm()">Limpar</button>
            <button class="ghost" onclick="logout()">Sair</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="busca" placeholder="Buscar por moto, serviço ou cliente..." oninput="filtrar()">
        <select id="ordenar" onchange="filtrar()">
          <option value="recente">Ordenar: Mais recente</option>
          <option value="antiga">Ordenar: Mais antiga</option>
          <option value="valorDesc">Valor (dec)</option>
          <option value="valorAsc">Valor (asc)</option>
        </select>
        <div class="row" style="margin-left:auto">
          <button class="ghost" onclick="carregar(true)">Atualizar</button>
        </div>
      </div>

      <table>
        <thead><tr><th>Moto</th><th>Cliente</th><th>Serviço</th><th>Valor</th><th>Data</th><th>Ação</th></tr></thead>
        <tbody id="lista"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal editar -->
  <div id="modal" style="display:none" class="modal-back">
    <div class="modal">
      <h3>Editar</h3>
      <input id="editMoto" placeholder="Moto">
      <input id="editCliente" placeholder="Cliente">
      <input id="editServico" placeholder="Serviço">
      <input id="editValor" placeholder="Valor">
      <input id="editData" type="date">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="primary" onclick="salvarEdit()">Salvar</button>
        <button class="ghost" onclick="closeModal()">Cancelar</button>
        <button class="ghost" style="margin-left:auto;color:var(--card);background:var(--danger);border:none" onclick="deleteEdit()">Apagar</button>
      </div>
    </div>
  </div>

</div>

<!-- Firebase (modular) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

/* ========== SUBSTITUA SOMENTE ESTE BLOCO PELA SUA CONFIG DO FIREBASE ========== */
const firebaseConfig = {
  apiKey: "AIzaSyB9St2-KhyhA7s6o_MsmkWOI8Feb0zytoM",
  authDomain: "controle-manutencao-20df9.firebaseapp.com",
  databaseURL: "https://controle-manutencao-20df9-default-rtdb.firebaseio.com",
  projectId: "controle-manutencao-20df9",
  storageBucket: "controle-manutencao-20df9.firebasestorage.app",
  messagingSenderId: "778808552103",
  appId: "1:778808552103:web:44ba1b6f586dfdaf1e8982"
};
/* ============================================================================ */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* UI refs */
const authCard = document.getElementById('authCard');
const registerBox = document.getElementById('registerBox');
const appUI = document.getElementById('app');
const userInfo = document.getElementById('userInfo');
const userLabel = document.getElementById('userLabel');
const listaEl = document.getElementById('lista');
const modal = document.getElementById('modal');

let cache = []; // cache local
let editId = null;

/* mostrar/ocultar auth */
document.getElementById('btnShowAuth').addEventListener('click', () => {
  authCard.style.display = authCard.style.display === 'none' ? 'block' : 'none';
});

function showRegister(){ registerBox.style.display = 'block'; }
function hideRegister(){ registerBox.style.display = 'none'; }

/* Autenticação */
window.login = async () => {
  const email = document.getElementById('emailLogin').value;
  const senha = document.getElementById('senhaLogin').value;
  if(!email || !senha) return alert('Preencha email e senha');
  try {
    await signInWithEmailAndPassword(auth, email, senha);
  } catch(e){
    alert(e.message);
  }
};

window.register = async () => {
  const email = document.getElementById('emailReg').value;
  const senha = document.getElementById('senhaReg').value;
  const nome = document.getElementById('nomeReg').value || '';
  if(!email || !senha) return alert('Preencha email e senha');
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
    if(nome) {
      await updateProfile(userCredential.user, { displayName: nome });
    }
    alert('Conta criada! Você já está logado.');
  } catch(e){
    alert(e.message);
  }
};

window.logout = () => signOut(auth);

/* Recuperação de senha */
window.recuperarSenha = async () => {
  const email = prompt('Informe o email para recuperação de senha:');
  if(!email) return alert('Email é obrigatório');
  try {
    await sendPasswordResetEmail(auth, email);
    alert('Email de recuperação enviado. Verifique sua caixa de entrada.');
  } catch(e){
    alert('Erro: ' + e.message);
  }
};

/* Observa estado do usuário */
onAuthStateChanged(auth, user => {
  if(user){
    authCard.style.display = 'none';
    appUI.style.display = 'block';
    userInfo.style.display = 'inline-block';
    userLabel.textContent = user.displayName || user.email;
    carregar();
  } else {
    appUI.style.display = 'none';
    userInfo.style.display = 'none';
    authCard.style.display = 'block';
  }
});

/* CRUD */
function limparForm(){
  ['moto','cliente','servico','valor','data'].forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
}

window.salvarNova = async () => {
  const moto = document.getElementById('moto').value.trim();
  const cliente = document.getElementById('cliente').value.trim();
  const servico = document.getElementById('servico').value.trim();
  const valorRaw = document.getElementById('valor').value.trim();
  const data = document.getElementById('data').value;

  if(!moto || !servico || !valorRaw || !data) return alert('Preencha moto, serviço, valor e data');

  const valor = parseFloat(valorRaw.replace(',', '.')) || 0;
  const uid = auth.currentUser.uid;

  // Salva dentro da coleção por usuário: usuarios/{uid}/manutencoes
  try {
    await addDoc(collection(db, 'usuarios', uid, 'manutencoes'), {
      uid, moto, cliente, servico, valor, data
    });
    limparForm();
    carregar(true);
  } catch(e){
    console.error(e); alert('Erro ao salvar: ' + e.message);
  }
};

async function carregar(force=false){
  if(!auth.currentUser) return;
  const uid = auth.currentUser.uid;
  const q = query(collection(db, 'usuarios', uid, 'manutencoes'));
  try {
    const snap = await getDocs(q);
    cache = [];
    snap.forEach(d => cache.push({ id: d.id, ...d.data() }));
    filtrar();
    if(force) alert('Dados atualizados');
  } catch(e){
    console.error(e); alert('Erro ao carregar: ' + e.message);
  }
}

/* Filtrar / Ordenar */
window.filtrar = () => {
  const texto = (document.getElementById('busca').value || '').toLowerCase();
  const ordem = document.getElementById('ordenar').value;
  let out = cache.filter(x => {
    return (x.moto||'').toLowerCase().includes(texto) ||
           (x.servico||'').toLowerCase().includes(texto) ||
           (x.cliente||'').toLowerCase().includes(texto);
  });

  if(ordem === 'recente') out.sort((a,b)=> (b.data||'').localeCompare(a.data||''));
  if(ordem === 'antiga') out.sort((a,b)=> (a.data||'').localeCompare(b.data||''));
  if(ordem === 'valorDesc') out.sort((a,b)=> b.valor - a.valor);
  if(ordem === 'valorAsc') out.sort((a,b)=> a.valor - b.valor);

  renderList(out);
};

function renderList(items){
  listaEl.innerHTML = '';
  items.forEach(i => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(i.moto||'')}</td>
      <td>${escapeHtml(i.cliente||'')}</td>
      <td>${escapeHtml(i.servico||'')}</td>
      <td>R$ ${Number(i.valor||0).toFixed(2)}</td>
      <td>${i.data||''}</td>
      <td class="actions">
        <button class="ghost" onclick="openEdit('${i.id}')">Editar</button>
        <button class="ghost" onclick="duplicate('${i.id}')">Duplicar</button>
        <button class="ghost" style="background:${'var(--danger)'};color:#fff;border:none" onclick="remover('${i.id}')">Apagar</button>
      </td>
    `;
    listaEl.appendChild(tr);
  });
}

/* escape simples */
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* Edit modal */
window.openEdit = (id) => {
  editId = id;
  const doc = cache.find(x => x.id === id);
  if(!doc) return alert('Registro não encontrado');
  document.getElementById('editMoto').value = doc.moto || '';
  document.getElementById('editCliente').value = doc.cliente || '';
  document.getElementById('editServico').value = doc.servico || '';
  document.getElementById('editValor').value = doc.valor || '';
  document.getElementById('editData').value = doc.data || '';
  modal.style.display = 'flex';
};

window.closeModal = () => { modal.style.display = 'none'; editId = null; };

window.salvarEdit = async () => {
  if(!editId) return;
  const moto = document.getElementById('editMoto').value.trim();
  const cliente = document.getElementById('editCliente').value.trim();
  const servico = document.getElementById('editServico').value.trim();
  const valor = parseFloat((document.getElementById('editValor').value||'').replace(',','.')) || 0;
  const data = document.getElementById('editData').value;
  if(!moto || !servico || !data) return alert('Preencha moto, serviço e data');
  try {
    const uid = auth.currentUser.uid;
    const ref = doc(db, 'usuarios', uid, 'manutencoes', editId);
    await updateDoc(ref, { moto, cliente, servico, valor, data });
    closeModal();
    carregar(true);
  } catch(e){
    console.error(e); alert('Erro ao salvar edição: ' + e.message);
  }
};

window.deleteEdit = async () => {
  if(!editId) return;
  if(!confirm('Confirmar exclusão?')) return;
  try {
    const uid = auth.currentUser.uid;
    await deleteDoc(doc(db, 'usuarios', uid, 'manutencoes', editId));
    closeModal();
    carregar(true);
  } catch(e){
    console.error(e); alert('Erro ao apagar: ' + e.message);
  }
};

/* duplicar */
window.duplicate = async (id) => {
  const doc = cache.find(x => x.id === id);
  if(!doc) return;
  const uid = auth.currentUser.uid;
  const copy = { ...doc }; delete copy.id;
  try {
    await addDoc(collection(db, 'usuarios', uid, 'manutencoes'), copy);
    carregar(true);
  } catch(e){ console.error(e); alert('Erro ao duplicar: ' + e.message); }
};

window.remover = async (id) => {
  if(!confirm('Confirmar exclusão?')) return;
  try {
    const uid = auth.currentUser.uid;
    await deleteDoc(doc(db, 'usuarios', uid, 'manutencoes', id));
    carregar(true);
  } catch(e){ console.error(e); alert('Erro ao apagar: ' + e.message); }
};

/* inicial: tenta carregar (se já estiver logado) */
carregar();

</script>
</body>
</html>
